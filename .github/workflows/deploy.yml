name: Deploy to Server

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
      
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # è¿›å…¥éƒ¨ç½²ç›®å½•
            cd ${{ secrets.DEPLOY_PATH }}
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "redink" ]; then
              echo "ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
              cp -r redink redink_backup_$(date +%Y%m%d_%H%M%S) || true
            fi
            
            # å…‹éš†æˆ–æ›´æ–°ä»£ç 
            if [ -d "redink/.git" ]; then
              echo "ğŸ”„ æ›´æ–°ä»£ç ..."
              cd redink
              git fetch origin
              git reset --hard origin/main
            else
              echo "ğŸ“¥ å…‹éš†ä»£ç ..."
              rm -rf redink
              git clone https://github.com/${{ github.repository }}.git redink
              cd redink
            fi
            
            # æ„å»º Docker é•œåƒ
            echo "ğŸ—ï¸ æ„å»º Docker é•œåƒ..."
            docker build -t redink:latest .
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker-compose down || true
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker-compose up -d
            
            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
            sleep 5
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            if [ "$(docker ps -q -f name=redink)" ]; then
              echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸï¼"
              docker-compose ps
            else
              echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥ï¼"
              docker-compose logs --tail=50
              exit 1
            fi
            
            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
            docker image prune -f
            
            # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
            cd ${{ secrets.DEPLOY_PATH }}
            ls -dt redink_backup_* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
      
      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸš€ éƒ¨ç½²æˆåŠŸï¼"
            echo "æäº¤: ${{ github.sha }}"
            echo "åˆ†æ”¯: ${{ github.ref_name }}"
            echo "ä½œè€…: ${{ github.actor }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
